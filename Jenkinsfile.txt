 pipeline {
  agent any

  environment {
        DOCKER_IMAGE_NAME = 'billyplut/my-app'
        BUILD_NUMBER = "${env.BUILD_NUMBER}"
  }

  stages {
    stage('Checkout repository') {
      steps {
        checkout scm
      }
    }
    
    stage('Build') {
      steps {
        sh '''
           echo "Starting build "
           chmod +x scripts/build.sh
           scripts/build.sh
           '''
      }
    }

    stage('Test') {
      steps {
        sh '''
           echo "Starting test "
           chmod +x scripts/test.sh
           scripts/test.sh
           '''
      }
    }

    stage('Build Docker image ') {
      steps {
        sh 'docker build -t $DOCKER_IMAGE_NAME:$BUILD_NUMBER .'
      }
    }

    stage('Push Docker Image ðŸ›’') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker_hub_creds_id', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
        sh '''
           echo "Logging in to Docker Hub..."
           docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
           echo "Pushing image..."
           docker push $DOCKER_IMAGE_NAME:$BUILD_NUMBER
           docker logout
           '''
        }
      }
    }
  }
}
